<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>
  <body>
    <script type="module">
      if ("serviceWorker" in navigator) {
        if (!navigator.serviceWorker.controller) {
          navigator.serviceWorker
            .register("/swenc-proxy-sw.js", { type: "module" })
            .then((registration) => {
              console.log("ServiceWorker registered", registration);
            })
            .catch((error) => {
              console.error("ServiceWorker registration failed: ", error);
              if (navigator.userAgent.toLowerCase().includes("firefox")) {
                alert(`ERROR: ServiceWorker registration failed!
Since you are on Firefox, this may be due to missing 'import' support in ServiceWorkers. Please try a Chromium-based browser instead.
(https://caniuse.com/mdn-javascript_statements_import_service_worker_support)`);
              }
            });

          // TODO: check key with API. maybe record fingerprint of key and store multiple
          navigator.serviceWorker.ready.then((registration) => {
            registration.active.postMessage({
              type: "setKey",
              key: prompt("Enter the encryption key:"),
            });
          });
        }
      }

      document.getElementById("form").addEventListener("submit", (event) => {
        event.preventDefault();
        const url = event.target.url.value;
        // No need to set targetOrigin yet, because absolute URL here
        location.href = new URL("/swenc-proxy/url?" + new URLSearchParams({ url }), location.origin).href;
      });
    </script>
    <form id="form">
      <label for="url">URL:</label>
      <input name="url" type="text" value="https://example.com" />
      <button type="submit">Go!</button>
    </form>
  </body>
</html>
