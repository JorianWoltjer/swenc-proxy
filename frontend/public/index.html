<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>
  <body>
    <script type="module">
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/worker.js", { type: "module" });
      }

      // TODO: somehow this gets unregistered on github & netflix
      navigator.serviceWorker.ready.then((registration) => {
        if (localStorage.getItem("key") === null) {
          localStorage.setItem("key", prompt("Enter the encryption key:"));
        }
        registration.active.postMessage({
          type: "setKey",
          key: localStorage.getItem("key"),
        });
      });

      function toDummy(url) {
        return "/dummy?" + new URLSearchParams({ url });
      }

      document.getElementById("form").addEventListener("submit", (event) => {
        event.preventDefault();
        const url = event.target.url.value;
        location.href = toDummy(url);
      });
    </script>
    <form id="form">
      <label for="url">URL:</label>
      <input name="url" type="text" value="https://example.com" />
      <button type="submit">Go!</button>
    </form>
  </body>
</html>
